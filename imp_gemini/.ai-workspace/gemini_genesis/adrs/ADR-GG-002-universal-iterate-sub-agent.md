# ADR-GG-002: Universal Iterate Sub-Agent

**Status**: Accepted
**Date**: 2026-02-21
**Deciders**: Gemini CLI Agent
**Requirements**: REQ-ITER-001, REQ-ITER-002, REQ-EVAL-001
**Supersedes**: ADR-008 (Universal Iterate Agent) — for Gemini Genesis implementation

---

## Context

The Asset Graph Model defines a universal iteration function `iterate(Asset, Context[], Evaluators)`. In Claude Code (ADR-008), this is implemented as a single, large markdown-based agent (`aisdlc-iterate.md`) that reads edge configuration and switches personas.

Gemini CLI offers a native **Sub-agent** architecture, which allows a main orchestrator to delegate tasks to specialized experts. We need to decide how to map the universal iteration function to this architecture.

### Options Considered

1.  **Single Generic Sub-agent**: One sub-agent that reads YAML edge configs, matching the Claude implementation.
2.  **Dynamic Expert Routing**: A main `aisdlc_iterate` tool that dynamically chooses the most appropriate sub-agent (e.g., `codebase_investigator` for design, a custom `test_fixing_agent` for co-evolution) and injects the methodology context.
3.  **Hybrid "Template Agent"**: A single sub-agent but with a prompt that is dynamically generated by the tool based on the edge parameterization.

---

## Decision

**We will use a hybrid "Template Agent" approach where a core `aisdlc_investigator` Sub-agent is configured dynamically by the `aisdlc_iterate` Tool.**

The Tool will:
1.  Read the `graph_topology.yml` and `edge_params/*.yml`.
2.  Pre-process the `Context[]` (ADRs, etc.) into a condensed prompt segment.
3.  Inject the **Effective Checklist** (evaluators) directly into the Sub-agent's instructions.
4.  Launch the Sub-agent with the current `Asset` as the primary focus.

---

## Rationale

### Why This Approach (vs Claude's Static Agent)

1.  **Instruction Density**: By injecting only the *relevant* edge config and evaluators, we keep the Sub-agent's prompt concise and focused, reducing the "noise" of unused edge definitions.
2.  **Tool-Driven Consistency**: The Tool handles the heavy lifting of context resolution ($variable expansion, dependency checking), ensuring the Sub-agent only receives "clean" data.
3.  **Sub-agent Specialization**: If a specific edge (e.g., `code↔unit_tests`) proves too complex for the generic investigator, the tool can easily be updated to route to a specialized sub-agent without changing the overall methodology flow.
4.  **Parallel Iteration**: Gemini's Sub-agent model can support parallel iteration on multiple feature vectors more natively than a single chat-bound agent.

---

## Consequences

### Positive

-   **Modular Prompting**: The Sub-agent's instructions are tailored for the *current* iteration, leading to higher-quality construction and evaluation.
-   **Reduced Hallucination**: Clearer boundaries between "Methodology Rules" and "Project Code" are enforced by the Tool's pre-processing.
-   **Traceability**: The Tool can explicitly log the "Effective Instructions" it sends to the Sub-agent, creating a better audit trail than a static agent.

### Negative

-   **Increased Tool Complexity**: The `aisdlc_iterate` tool becomes a sophisticated prompt-builder.
-   **Latency**: Loading a new Sub-agent and injecting context for every iteration adds overhead.

### Mitigation

-   Implement **caching** for context hashes to avoid re-reading files when the environment hasn't changed.
-   Use clear, versioned templates for the Sub-agent's core instructions.

---

## References

- [GEMINI_GENESIS_DESIGN.md](../GEMINI_GENESIS_DESIGN.md) §1.3
- [ADR-008: Universal Iterate Agent](../../claude_aisdlc/adrs/ADR-008-universal-iterate-agent.md)
