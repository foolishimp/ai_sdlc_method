# Feature: Requirement Traceability
# Validates: REQ-NFR-TRACE-001, REQ-NFR-TRACE-002
# Stage: System Test (Stage 5)

@system-test @traceability @REQ-NFR-TRACE-001 @REQ-NFR-TRACE-002
Feature: Full Lifecycle Requirement Traceability
  As a project manager or quality engineer
  I want complete traceability from intent to runtime
  So that I can verify requirements are implemented and validated

  Background:
    Given the AISDLC methodology is in use
    And a project workspace exists with requirements

  # ===========================================================================
  # Requirement Key Format (REQ-NFR-TRACE-001)
  # ===========================================================================

  @key-format @TR-001
  Scenario: Requirement keys follow standard format
    Given requirements are generated by the Requirements Agent
    When I inspect the requirement keys
    Then all keys should match the standard patterns:
      | Pattern           | Example         | Type                     |
      | REQ-F-*-NNN       | REQ-F-AUTH-001  | Functional requirement   |
      | REQ-NFR-*-NNN     | REQ-NFR-SEC-001 | Non-functional req       |
      | REQ-DATA-*-NNN    | REQ-DATA-VAL-001| Data quality req         |
      | REQ-BR-*-NNN      | REQ-BR-PRICE-001| Business rule            |
    And the NNN portion should be a zero-padded 3-digit number

  @key-format @TR-002
  Scenario: Requirement keys are unique and immutable
    Given requirements REQ-F-AUTH-001 and REQ-F-AUTH-002 exist
    When I attempt to create a duplicate REQ-F-AUTH-001
    Then the system should reject the duplicate
    And an error should indicate key collision

    When I attempt to modify REQ-F-AUTH-001's key to REQ-F-AUTH-003
    Then the modification should be rejected
    And the key should remain REQ-F-AUTH-001

  # ===========================================================================
  # Forward Traceability (Intent → Requirements → Code)
  # ===========================================================================

  @forward @TR-010
  Scenario: Trace from intent to requirements
    Given an intent with ID INT-001:
      """
      Build user authentication with login and registration
      """
    When the Requirements Agent processes the intent
    Then requirements should be created:
      | Key            | Traces To |
      | REQ-F-AUTH-001 | INT-001   |
      | REQ-F-AUTH-002 | INT-001   |
    And each requirement should have:
      | Field             | Present |
      | Intent reference  | Yes     |
      | Description       | Yes     |
      | Acceptance criteria| Yes    |

  @forward @TR-011
  Scenario: Trace from requirements to design
    Given requirements:
      | Key            | Description           |
      | REQ-F-AUTH-001 | User login            |
      | REQ-F-AUTH-002 | User registration     |
    When the Design Agent creates a solution
    Then design artifacts should trace to requirements:
      | Artifact          | Traces To              |
      | AuthService       | REQ-F-AUTH-001         |
      | RegistrationFlow  | REQ-F-AUTH-002         |
      | User data model   | REQ-F-AUTH-001, 002    |

  @forward @TR-012
  Scenario: Trace from design to tasks
    Given a design component AuthService traces to REQ-F-AUTH-001
    When the Tasks Agent creates work units
    Then tasks should maintain traceability:
      | Task ID   | Component    | Requirement    |
      | TASK-001  | AuthService  | REQ-F-AUTH-001 |
      | TASK-002  | AuthService  | REQ-F-AUTH-001 |

  @forward @TR-013
  Scenario: Trace from tasks to code
    Given a task TASK-001 with requirement REQ-F-AUTH-001
    When the Code Agent implements the task
    Then the code should contain requirement tags:
      """
      # Implements: REQ-F-AUTH-001
      # Task: TASK-001
      class AuthService:
          def login(self, email: str, password: str):
              ...
      """

  @forward @TR-014
  Scenario: Trace from code to tests
    Given code implementing REQ-F-AUTH-001
    When tests are written for the code
    Then test files should contain validation tags:
      """
      # Validates: REQ-F-AUTH-001
      class TestAuthService:
          def test_login_success(self):
              ...
      """

  # ===========================================================================
  # Backward Traceability (Runtime → Code → Requirements)
  # ===========================================================================

  @backward @TR-020
  Scenario: Trace from runtime issue to requirement
    Given a production error:
      | Field     | Value                    |
      | Service   | AuthService              |
      | Error     | Login timeout            |
      | Code file | auth_service.py:42       |
    When I trace the issue backward
    Then I should find:
      | Level      | Artifact          | Requirement    |
      | Code       | auth_service.py   | REQ-F-AUTH-001 |
      | Task       | TASK-001          | REQ-F-AUTH-001 |
      | Design     | AuthService       | REQ-F-AUTH-001 |
      | Requirement| REQ-F-AUTH-001    | INT-001        |

  @backward @TR-021
  Scenario: Trace from test failure to requirement
    Given a failing test:
      | Test file         | test_auth.py::test_login |
      | Error             | Assertion failed          |
    When I trace the test to requirements
    Then I should find REQ-F-AUTH-001
    And I should see which acceptance criteria failed

  # ===========================================================================
  # Traceability Matrix (REQ-NFR-TRACE-001)
  # ===========================================================================

  @matrix @TR-030
  Scenario: Generate traceability matrix
    Given the project has:
      | Type          | Count |
      | Requirements  | 10    |
      | Design docs   | 5     |
      | Tasks         | 15    |
      | Code files    | 20    |
      | Test files    | 25    |
    When I generate the traceability matrix
    Then the matrix should show:
      | Requirement    | Design | Tasks | Code | Tests | UAT | Status    |
      | REQ-F-AUTH-001 | Yes    | 2     | 3    | 5     | Yes | Complete  |
      | REQ-F-AUTH-002 | Yes    | 1     | 2    | 3     | Yes | Complete  |
      | REQ-F-DATA-001 | Yes    | 1     | 1    | 0     | No  | Incomplete|

  @matrix @TR-031
  Scenario: Identify coverage gaps
    Given requirements with incomplete coverage
    When I analyze the traceability matrix
    Then gaps should be highlighted:
      | Requirement    | Missing Coverage          | Priority |
      | REQ-F-DATA-001 | Tests, UAT                | HIGH     |
      | REQ-NFR-PERF-001| System tests             | MEDIUM   |

  @matrix @TR-032
  Scenario: Traceability matrix updates automatically
    Given a traceability matrix exists
    When I add new code with "# Implements: REQ-F-NEW-001"
    And I refresh the traceability matrix
    Then REQ-F-NEW-001 should appear with code coverage

  # ===========================================================================
  # Requirement Key Propagation (REQ-NFR-TRACE-002)
  # ===========================================================================

  @propagation @TR-040
  Scenario: REQ keys propagate through code comments
    Given a requirement REQ-F-AUTH-001
    When code is written implementing this requirement
    Then the code should contain:
      """
      # Implements: REQ-F-AUTH-001
      """
    And the comment should be parseable by tools

  @propagation @TR-041
  Scenario: REQ keys propagate through commit messages
    Given a task completing REQ-F-AUTH-001
    When a commit is created via /aisdlc-commit-task
    Then the commit message should contain:
      """
      Implements: REQ-F-AUTH-001
      """

  @propagation @TR-042
  Scenario: REQ keys propagate through BDD scenarios
    Given a requirement REQ-F-AUTH-001
    When BDD scenarios are created
    Then the feature file should contain:
      """
      # Validates: REQ-F-AUTH-001
      Feature: User Authentication
      """
    And individual scenarios should reference the requirement

  @propagation @TR-043
  Scenario: REQ keys propagate through release notes
    Given requirements REQ-F-AUTH-001 and REQ-F-AUTH-002 implemented
    When a release is created
    Then the release notes should list:
      | Requirement    | Status     | Commits |
      | REQ-F-AUTH-001 | Implemented| 3       |
      | REQ-F-AUTH-002 | Implemented| 2       |

  @propagation @TR-044
  Scenario: REQ keys propagate through runtime telemetry
    Given REQ-F-AUTH-001 is deployed to production
    When the service logs events
    Then logs should be tagged:
      """
      {"level": "INFO", "message": "User logged in", "requirement": "REQ-F-AUTH-001"}
      """
    And metrics should be labeled with requirement keys

  # ===========================================================================
  # Cross-Stage Traceability Validation
  # ===========================================================================

  @validation @TR-050
  Scenario: Validate complete traceability chain
    Given a requirement REQ-F-AUTH-001 exists
    When I validate its traceability chain
    Then the following artifacts should be linked:
      | Stage          | Artifact Type    | Required | Found |
      | Intent         | Intent document  | Optional | Yes   |
      | Requirements   | REQ-F-AUTH-001   | Required | Yes   |
      | Design         | Component/ADR    | Required | Yes   |
      | Tasks          | Work units       | Required | Yes   |
      | Code           | Source files     | Required | Yes   |
      | Unit Tests     | Test files       | Required | Yes   |
      | System Tests   | BDD scenarios    | Required | Yes   |
      | UAT            | UAT test cases   | Required | Yes   |
      | Runtime        | Telemetry config | Optional | Yes   |

  @validation @TR-051
  Scenario: Detect orphan artifacts
    Given code exists without requirement tags:
      """
      # No Implements tag
      def orphan_function():
          pass
      """
    When I run traceability validation
    Then the validator should report:
      | File             | Issue                     | Severity |
      | orphan_code.py   | No requirement reference  | Warning  |
    And suggestions should be provided to link to requirements

  @validation @TR-052
  Scenario: Detect orphan requirements
    Given a requirement REQ-F-ORPHAN-001 exists
    And no code implements this requirement
    When I run traceability validation
    Then the validator should report:
      | Requirement      | Issue                | Severity |
      | REQ-F-ORPHAN-001 | No implementation    | Error    |

  # ===========================================================================
  # Traceability Reports
  # ===========================================================================

  @reports @TR-060
  Scenario: Generate requirement coverage report
    When I generate a requirement coverage report
    Then the report should include:
      | Section            | Content                          |
      | Summary            | Total reqs, % covered            |
      | By Category        | F: 80%, NFR: 70%, DATA: 50%      |
      | Uncovered          | List of requirements lacking tests|
      | Recommendations    | Priority actions to improve      |

  @reports @TR-061
  Scenario: Generate impact analysis report
    Given I want to modify REQ-F-AUTH-001
    When I generate an impact analysis report
    Then the report should show:
      | Impacted Artifact | Type       | Details                     |
      | AuthService       | Component  | Core implementation         |
      | TASK-001, TASK-002| Tasks      | Related work units          |
      | auth_service.py   | Code       | 3 functions affected        |
      | test_auth.py      | Tests      | 5 tests may need updates    |
      | auth.feature      | BDD        | 3 scenarios affected        |
      | UAT-001, UAT-002  | UAT        | Business validation needed  |

  @reports @TR-062
  Scenario: Generate release traceability report
    Given a release v1.0.0 is planned
    And the release includes requirements:
      | Requirement    | Status      |
      | REQ-F-AUTH-001 | Implemented |
      | REQ-F-AUTH-002 | Implemented |
      | REQ-F-DATA-001 | Partial     |
    When I generate a release traceability report
    Then the report should show:
      | Requirement    | Code | Tests | UAT | Release Ready |
      | REQ-F-AUTH-001 | Yes  | Yes   | Yes | YES           |
      | REQ-F-AUTH-002 | Yes  | Yes   | Yes | YES           |
      | REQ-F-DATA-001 | Yes  | No    | No  | NO            |
