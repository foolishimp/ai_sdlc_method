# Edge Parameterisation: Code ↔ Unit Tests (TDD Co-Evolution)
# Implements: REQ-EDGE-001
# Reference: AI_SDLC_ASSET_GRAPH_MODEL.md §4.1

---

edge: "code↔unit_tests"
pattern: tdd_co_evolution
description: |
  Test-Driven Development as co-evolution of code and tests.
  This is a BIDIRECTIONAL edge — tests and code iterate together.
  Neither is "upstream" of the other; they converge jointly.

phases:
  red:
    description: "Write failing test first"
    action: |
      Write a test that exercises the next piece of functionality.
      The test MUST:
      - Reference the requirement: # Validates: REQ-*
      - Follow AAA pattern (Arrange, Act, Assert)
      - Be specific and focused (one behaviour per test)
      - FAIL when run (no implementation yet)
    evaluator: deterministic
    convergence: "Test exists, is syntactically valid, and fails as expected"

  green:
    description: "Write minimal code to pass"
    action: |
      Write the MINIMUM code needed to make the test pass.
      The code MUST:
      - Reference the requirement: # Implements: REQ-*
      - Be minimal — no premature optimisation or extra features
      - Make the specific failing test pass
    evaluator: deterministic
    convergence: "All tests pass (not just the new one)"

  refactor:
    description: "Improve code quality while tests stay green"
    action: |
      Improve the code and/or tests:
      - Extract patterns, reduce duplication
      - Improve naming, readability
      - Add type hints, documentation
      - Ensure tests still pass after every change
    evaluator: [agent, deterministic]
    convergence: "Tests still pass, agent confirms quality improvement"

  commit:
    description: "Save with REQ key in commit message"
    action: |
      Commit the changes with a message that:
      - Describes what was implemented
      - Lists Implements: REQ-* tags
      - Notes test evidence (count, coverage)
    evaluator: deterministic
    convergence: "Commit message includes REQ-* tag"

# After commit, cycle repeats with next test
cycle: "red → green → refactor → commit → red"

# Convergence criteria for the full TDD edge
convergence:
  all_tests_pass: true
  coverage_threshold: 0.80
  critical_path_coverage: 1.00
  all_req_keys_covered: true  # Every REQ-* in scope has at least one test
  no_untested_code_paths: false  # Aspirational, not blocking

# Guidance for the iterate agent
agent_guidance: |
  When iterating on this edge:
  1. Always start with RED — never write code before the test
  2. Keep GREEN minimal — resist adding "while I'm here" changes
  3. REFACTOR is mandatory, not optional — this is where quality lives
  4. If a test can't be written, that's feedback: the requirement or design is unclear
  5. Track which REQ keys are covered vs uncovered
  6. Report coverage gaps as part of the delta
